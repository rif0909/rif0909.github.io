angular.module("myDirective",[]).directive("customOnChange",function(){return{restrict:"A",link:function(a,b,c){a=a.$eval(c.customOnChange);b.bind("change",a)}}}).directive("setting",function(){return function(a,b,c){a.$eval(c.setting)}}).directive("checkPrevious",function(){return{restrict:"A",link:function(a,b,c){b.bind("click",function(){Util.check(b)})}}});Questions=function(){var a=TAFFY(),b=[],c=[],e=[],f=[],d=[];return{init:function(b){a=TAFFY(b);c=[];f=[];a().group({column:"class",type:"is"}).forEach(function(a,b){c.push({name:a.group,count:a.count})})},get:function(){return 0<arguments.length?a(arguments).get():b},set:function(a){b=a},getClasses:function(){return c},setErrors:function(a){e=a},addErrors:function(a){e.push(a)},getErrors:function(){return e},clearErrors:function(){e=[]},search:function(b,c,d){if(3<=arguments.length){if(d)return a(b).search(c);var e=a(b);return e.search.apply(e,c)}return f},setSearched:function(a){f=a},setFlag:function(a){-1==d.indexOf(a)&&d.push(a);return d.length},unsetFlag:function(){if(0<arguments.length){var a=d.indexOf(arguments[0]);-1!=a&&d.splice(a,1)}else d=[];return d.length},hasFlag:function(a){return-1!=d.indexOf(a)},getFlags:function(){return d},getFlagQuestions:function(){return a({__id:d}).get()}}}();Question=function(a){this["class"]=a["class"];this.sn=a.sn;this.type=a.type;this.question=a.question;this.options=[];for(var b in a.options){var c=$.extend({},a.options[b]);c.selected=!1;this.options.push(c)}this.remark=a.remark;this.enough=this.correct=this.answered=!1;this.__id=a.__id;this.flag=Questions.hasFlag(a.__id)};TAFFY.extend("group",function(){var a,b,c=[],e=[],f=[],d=arguments;this.context({results:this.getDBI().query(this.context())});var k=TAFFY(this.context().results);$.each(d,function(){e.push(this.column)});var g=k().select.apply(k(),e);for(a=0;a<g.length;a++){if(1==d.length)d[0].func&&(g[a]=d[0].func.apply(g[a]));else for(b=0;b<d.length;b++)d[b].func&&(g[a][b]=d[b].func.apply(g[a][b]));var h=!1;for(b=0;b<f.length&&!(h=Util.equals(g[a],f[b]));b++);h||f.push(g[a])}c.count=0;c.groups=[];for(a=0;a<f.length;a++){g={};h={};var l=f[a];if(1==d.length)h[d[0].column]={},h[d[0].column][d[0].type]=l;else for(b=0;b<d.length;b++)h[d[b].column]={},h[d[b].column][d[b].type]=l[b];g.group=l;g.result=k(h).get();g.count=g.result.length;c.push(g);c.count+=g.count;c.groups.push(g.group)}return c});TAFFY.extend("search",function(){var a=[],b=arguments;this.context({results:this.getDBI().query(this.context())});tmp=this.context().results;1===b.length&&"[object Array]"===Object.prototype.toString.call(b[0])?$.each(tmp,function(){var c="",e=!0;$.each(this.options,function(){c=c+"|"+this.option.toLowerCase()});var f=this.question.toLowerCase();for(x in b[0]){var d=b[0][x].toLowerCase();if(-1===f.indexOf(d)&&-1===c.indexOf(d)){e=!1;break}}e&&a.push(this)}):$.each(tmp,function(){var c="",e=!1;$.each(this.options,function(){c=c+"|"+this.option.toLowerCase()});var f=this.question.toLowerCase();for(x in b){var d=b[x].toLowerCase();if(-1!==f.indexOf(d)||-1!==c.indexOf(d)){e=!0;break}}e&&a.push(this)});return a});Util=function(){check=function(a){if(void 0===a||isEmpty(a["class"])||isEmpty(a.question)||isEmpty(a.type))return!1;var b=a.options;if(void 0===b||"[object Array]"!==Object.prototype.toString.call(b))return!1;var c=0,e;for(e in b){if(isEmpty(b[e].option))return!1;!0===b[e].answer&&c++}a=a.type.toLowerCase();return"single"===a&&1===c||"multi"===a&&1<=c};isEmpty=function(a){return void 0===a||""===a};contains=function(a,b){for(var c in a)if(b["class"]===a[c]["class"]&&b.sn===a[c].sn)return!0;return!1};return{add:function(a,b){"[object Array]"===Object.prototype.toString.call(a)&&check(b)&&!contains(a,b)&&a.push(b)},shuffle:function(a){for(var b=a.length;0<b;){var c=Math.floor(Math.random()*b);b--;var e=a[b];a[b]=a[c];a[c]=e}return a},getDefaultSettings:function(){return{random:!1,memorize:!1,browse:!0,title:!0,single:!0,multi:!0,"class":!0,position:0,correctCount:0,incorrectCount:0,keyword:[],keywordRuleAnd:!0,flags:[]}},equals:function(a,b){if(typeof a!=typeof b)return!1;if(void 0==a)return!0;if(a.length!=b.length)return!1;if(void 0==a.length)return a===b;"string"==typeof a&&(a=a.split(""),b=b.split(""));for(i=0;i<a.length;i++)if(a[i]!=b[i])return!1;return!0},check:function(a){a=$(a).prev();if(!a.prop("disabled")){var b=a.attr("type");"checkbox"===b?a.prop("checked",!a.prop("checked")).trigger("change"):"radio"===b&&a.prop("checked",!0)}},rndCheck:function(){$("#random").prop("checked")?($("#memorize").prop("checked",!1),$("#memorize").prop("disabled",!0)):$("#memorize").prop("disabled",!1)},saveQuestions:function(a){var b=$("#dl"),c="",e=new Date;a.forEach(function(a){c+='{"class":"'+a["class"]+'","sn":"'+a.sn+'","type":"'+a.type+'","question":"'+a.question+'","options":[';a.options.forEach(function(a){c+='{"option":"'+a.option+'","answer":'+a.answer+"},"});c=c.slice(0,-1)+'],"remark":"'+a.remark+'"}\r\n'});b.attr("href","data:text/plain;charset=utf-8,"+encodeURIComponent(c));b.attr("download",e.getFullYear()+("0"+(e.getMonth()+1)).slice(-2)+("0"+e.getDate()).slice(-2)+("0"+e.getHours()).slice(-2)+("0"+e.getMinutes()).slice(-2)+("0"+e.getSeconds()).slice(-2)+".txt");b[0].click()},parseFile:function(a,b,c){var e=[];for(json in c){try{var f=c[json];f.indexOf(";;")===f.length-2&&(f=f.substring(0,f.length-2));var d=angular.fromJson(f);d.type=d.type.toLowerCase();d.__id=json}catch(k){}this.add(e,d)}0!==e.length?(localStorage.setItem("storedQuestions",angular.toJson(e)),Questions.init(e),b=localStorage.getItem("quiz.settings")||b.get("quiz.settings"),void 0===b?b=this.getDefaultSettings():(b=angular.fromJson(b),b={random:b.random,memorize:b.memorize,browse:b.browse,title:b.title},b=$.extend(this.getDefaultSettings(),b)),localStorage.removeItem("errorQuestions"),Questions.clearErrors(),a.hasFlags=Questions.unsetFlag(),a.hasErrors=!1,a.index=-1,localStorage.setItem("quiz.settings",angular.toJson(b)),a.initQuestions(),a.tab="quiz",a.file="",$("#close").click()):alert("\u9078\u64c7\u7684\u6a94\u6848\u5167\u7121\u7b26\u5408\u7684\u984c\u76ee!")}}}();