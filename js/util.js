angular.module("myDirective",[]).directive("customOnChange",function(){return{restrict:"A",link:function(a,b,c){a=a.$eval(c.customOnChange);b.bind("change",a)}}}).directive("setting",function(){return function(a,b,c){a.$eval(c.setting)}}).directive("checkPrevious",function(){return{restrict:"A",link:function(a,b,c){b.bind("click",function(){Util.check(b)})}}});Questions=function(){var a=TAFFY(),b=[],c=[],d=[],e=[];return{init:function(b){a=TAFFY(b);c=[];e=[];a().group({column:"class",type:"is"}).forEach(function(a,b){c.push({name:a.group,count:a.count})})},get:function(){return 0<arguments.length?a(arguments).get():b},set:function(a){b=a},getClasses:function(){return c},setErrors:function(a){d=a},addErrors:function(a){d.push(a)},getErrors:function(){return d},clearErrors:function(){d=[]},search:function(b,c,d){if(3<=arguments.length){if(d)return a(b).search(c);var f=a(b);return f.search.apply(f,c)}return e},setSearched:function(a){e=a}}}();Question=function(a){this["class"]=a["class"];this.sn=a.sn;this.type=a.type;this.question=a.question;this.options=[];for(var b in a.options){var c=$.extend({},a.options[b]);c.selected=!1;this.options.push(c)}this.remark=a.remark;this.enough=this.correct=this.answered=!1;this.__id=a.__id};TAFFY.extend("group",function(){var a,b,c,d,e=[],f=[],k=[],g=arguments;this.context({results:this.getDBI().query(this.context())});a=TAFFY(this.context().results);$.each(g,function(){f.push(this.column)});b=a().select.apply(a(),f);for(c=0;c<b.length;c++){if(1==g.length)g[0].func&&(b[c]=g[0].func.apply(b[c]));else for(d=0;d<g.length;d++)g[d].func&&(b[c][d]=g[d].func.apply(b[c][d]));var h=!1;for(d=0;d<k.length&&!(h=Util.equals(b[c],k[d]));d++);h||k.push(b[c])}e.count=0;e.groups=[];for(c=0;c<k.length;c++){b={};var h={},l;l=k[c];if(1==g.length)h[g[0].column]={},h[g[0].column][g[0].type]=l;else for(d=0;d<g.length;d++)h[g[d].column]={},h[g[d].column][g[d].type]=l[d];b.group=l;b.result=a(h).get();b.count=b.result.length;e.push(b);e.count+=b.count;e.groups.push(b.group)}return e});TAFFY.extend("search",function(){var a=[],b=arguments;this.context({results:this.getDBI().query(this.context())});tmp=this.context().results;1===b.length&&"[object Array]"===Object.prototype.toString.call(b[0])?$.each(tmp,function(){var c="",d=!0;$.each(this.options,function(){c=c+"|"+this.option.toLowerCase()});var e=this.question.toLowerCase();for(x in b[0]){var f=b[0][x].toLowerCase();if(-1===e.indexOf(f)&&-1===c.indexOf(f)){d=!1;break}}d&&a.push(this)}):$.each(tmp,function(){var c="",d=!1;$.each(this.options,function(){c=c+"|"+this.option.toLowerCase()});var e=this.question.toLowerCase();for(x in b){var f=b[x].toLowerCase();if(-1!==e.indexOf(f)||-1!==c.indexOf(f)){d=!0;break}}d&&a.push(this)});return a});Util=function(){check=function(a){if(void 0===a||isEmpty(a["class"])||isEmpty(a.question)||isEmpty(a.type))return!1;var b=a.options;if(void 0===b||"[object Array]"!==Object.prototype.toString.call(b))return!1;var c=0,d;for(d in b){if(isEmpty(b[d].option))return!1;!0===b[d].answer&&c++}a=a.type.toLowerCase();return"single"===a&&1===c||"multi"===a&&1<=c};isEmpty=function(a){return void 0===a||""===a};contains=function(a,b){for(var c in a)if(b["class"]===a[c]["class"]&&b.sn===a[c].sn)return!0;return!1};return{add:function(a,b){"[object Array]"===Object.prototype.toString.call(a)&&check(b)&&!contains(a,b)&&a.push(b)},shuffle:function(a){for(var b=a.length;0<b;){var c=Math.floor(Math.random()*b);b--;var d=a[b];a[b]=a[c];a[c]=d}return a},getDefaultSettings:function(){return{random:!1,memorize:!1,browse:!0,title:!0,single:!0,multi:!0,"class":!0,position:0,correctCount:0,incorrectCount:0,keyword:[],keywordRuleAnd:!0}},equals:function(a,b){if(typeof a!=typeof b)return!1;if(void 0==a)return!0;if(a.length!=b.length)return!1;if(void 0==a.length)return a===b;"string"==typeof a&&(a=a.split(""),b=b.split(""));for(i=0;i<a.length;i++)if(a[i]!=b[i])return!1;return!0},check:function(a){a=$(a).prev();if(!a.prop("disabled")){var b=a.attr("type");"checkbox"===b?a.prop("checked",!a.prop("checked")).trigger("change"):"radio"===b&&a.prop("checked",!0)}},rndCheck:function(){$("#random").prop("checked")?($("#memorize").prop("checked",!1),$("#memorize").prop("disabled",!0)):$("#memorize").prop("disabled",!1)},saveQuestions:function(a){var b=$("#dl"),c="",d=new Date;a.forEach(function(a){c+='{"class":"'+a["class"]+'","sn":"'+a.sn+'","type":"'+a.type+'","question":"'+a.question+'","options":[';a.options.forEach(function(a){c+='{"option":"'+a.option+'","answer":'+a.answer+"},"});c=c.slice(0,-1)+'],"remark":"'+a.remark+'"}\r\n'});b.attr("href","data:text/plain;charset=utf-8,"+encodeURIComponent(c));b.attr("download",d.getFullYear()+("0"+(d.getMonth()+1)).slice(-2)+("0"+d.getDate()).slice(-2)+("0"+d.getHours()).slice(-2)+("0"+d.getMinutes()).slice(-2)+("0"+d.getSeconds()).slice(-2)+".txt");b[0].click()},parseFile:function(a,b,c){var d=[];for(json in c){try{var e=c[json];e.indexOf(";;")===e.length-2&&(e=e.substring(0,e.length-2));var f=angular.fromJson(e);f.type=f.type.toLowerCase();f.__id=json}catch(k){}this.add(d,f)}0!==d.length?(localStorage.setItem("storedQuestions",angular.toJson(d)),Questions.init(d),b=localStorage.getItem("quiz.settings")||b.get("quiz.settings"),void 0===b?b=this.getDefaultSettings():(b=angular.fromJson(b),b={random:b.random,memorize:b.memorize,browse:b.browse,title:b.title},b=$.extend(this.getDefaultSettings(),b)),localStorage.removeItem("errorQuestions"),Questions.clearErrors(),a.hasErrors=!1,a.index=-1,localStorage.setItem("quiz.settings",angular.toJson(b)),a.initQuestions(),a.tab="quiz",a.file="",$("#close").click()):alert("\u9078\u64c7\u7684\u6a94\u6848\u5167\u7121\u7b26\u5408\u7684\u984c\u76ee!")}}}();