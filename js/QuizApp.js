angular.module("QuizApp",["myDirective","ngCookies"]).controller("QuizController",["$log","$scope","$cookies",function(h,k,e){var f=this;this.incorrectCount=this.correctCount=0;this.index=-1;this.tab="file";this.hasErrors=this.title=this.browse=this.random=!1;this.eMax=this.eIndex=-1;this.errMsg="";this.keyword=[];this.keywordRuleAnd=!0;this.toTab=function(a){this.tab=a;$(".navbar-toggle").click()};this.jump=function(){$("#sn").val("");$("#errmsg").hide();$("#jump").modal("toggle");$(".navbar-toggle").click()};this.closeMenu=function(){$(".navbar-toggle").click()};this.clear=function(){$("#files").val("")};this.close=function(){this.tab=this.question?"quiz":"file";this.clear()};this.radio=function(a,b){var c=$("input[name='answer']:eq("+a+")");c.prop("disabled")||(c.prop("checked",!0),this.check(b))};this.ckbox=function(a,b){var c=$("input[name='answer']:eq("+a+")");c.prop("disabled")||(c.prop("checked",!c.prop("checked")),this.check(b))};this.check=function(a){a.stopPropagation();var b=0;$("input[name='answer']").each(function(){$(this).prop("checked")&&b++});a=this.question.type.toLowerCase();this.question.enough="single"===a&&1===b||"multi"===a&&1<b};this.answer=function(){this.question.type.toLowerCase();var a=!0;$("input[name='answer']").each(function(b){var c=$(this);c.prop("disabled",!0);a=a&&!(c.prop("checked")^"true"===c.attr("value"));f.question.options[b].selected=c.prop("checked")});this.question.answered=!0;(this.question.correct=a)?this.correctCount++:(this.incorrectCount++,this.hasErrors=!0,Questions.setErrors(this.question))};this.next=function(a){a=this.index+a;var b=0!==this.keyword.length?Questions.search():Questions.get();a===b.length&&(a=0,this.random&&Util.shuffle(b));this.index=a;Util.shuffle(b[this.index].options);this.question=new Question(b[this.index]);a=e.get("quiz.settings");a=void 0===a?Util.getDefaultSettings():$.extend(Util.getDefaultSettings(),angular.fromJson(a));a.memorize&&(a.position=this.index,b=new Date,b.setDate(b.getDate()+7),e.put("quiz.settings",angular.toJson(a),{expires:b}))};this.jumpTo=function(){var a=parseInt($("#sn").val(),10);1<=a&&a<=this.questions.length?(this.index=a-1,this.next(0),$("#sn").val(""),$("#errmsg").hide(),$("#jump").modal("toggle")):($("#sn").val(""),$("#errmsg").show())};this.parseFile=function(a){a=a.target.files[0];var b=new FileReader;b.onload=function(a){a=b.result.split(";;");var d=[];for(json in a){try{var g=angular.fromJson(a[json]);g.type=g.type.toLowerCase();g.__id=json}catch(e){}Util.add(d,g)}0!==d.length?(Questions.init(d),f.keyword=[],f.initQuestions(),f.tab="quiz",$("#close").click()):alert("\u9078\u64c7\u7684\u6a94\u6848\u5167\u7121\u7b26\u5408\u7684\u984c\u76ee!")};b.readAsText(a)};this.save=function(){this.saveCookie(e)&&(0===this.keyword.length?this.initQuestions():this.initKeyword(),this.tab="quiz")};this.loadCookie=function(a){var b=e.get("quiz.settings"),b=void 0===b?Util.getDefaultSettings():$.extend(Util.getDefaultSettings(),angular.fromJson(b));b.random?$("#random").prop("checked",b.random).trigger("change"):$("#memorize").prop("checked",b.memorize);$("#browse").prop("checked",b.browse);$("#title").prop("checked",b.title);$("#single").prop("checked",b.single);$("#multi").prop("checked",b.multi);$("#classes").append('<div class="col-xs-12"><b>\u985e\u5225\u8a2d\u5b9a</b></div>');a=Questions.getClasses();for(var c=0;c<a.length;c++)$("#classes").append('<div class="col-xs-4" name="xxx"><input type="checkbox" name="class" value="'+a[c].name+'" /><span>'+a[c].name+"["+a[c].count+"]</span></div>");$("#classes").find("span").each(function(){$(this).on("click",function(){Util.check(this)})});"boolean"===typeof b["class"]?$('input[name="class"]').each(function(){$(this).prop("checked",!0)}):"string"===typeof b["class"]&&$('input[name="class"]').each(function(){var a=$(this);-1!==b["class"].indexOf(a.val())&&a.prop("checked",!0)})};this.saveCookie=function(){var a=Util.getDefaultSettings();a.random=$("#random").prop("checked");a.memorize=$("#memorize").prop("checked");a.browse=$("#browse").prop("checked");a.title=$("#title").prop("checked");a.single=$("#single").prop("checked");a.multi=$("#multi").prop("checked");a.position=a.random?0:this.index;var b="";$('input[name="class"]').each(function(){var a=$(this);a.prop("checked")&&(b+=a.val()+",")});if(""===b)return this.errMsg="\u8acb\u81f3\u5c11\u9078\u64c7\u4e00\u7a2e\u985e\u5225",$("#warning").modal("toggle"),!1;if(a.single||a.multi){a["class"]=b.substring(0,b.length-1);var c={};c["class"]=a["class"].split(",");a.single&&!a.multi?c.type="single":a.multi&&!a.single&&(c.type="multi");var d=[];if(0===this.keyword.length){d=Questions.get(c);if(0===d.length)return this.errMsg="\u9078\u64c7\u7684\u985e\u5225\u53ca\u984c\u578b\u672a\u5305\u542b\u4efb\u4f55\u984c\u76ee",$("#warning").modal("toggle"),!1;Questions.set(d)}else{d=Questions.search(c,this.keyword,this.keywordRuleAnd);if(0===d.length)return this.errMsg="\u9078\u64c7\u7684\u985e\u5225\u53ca\u984c\u578b\u672a\u5305\u542b\u4efb\u4f55\u984c\u76ee",$("#warning").modal("toggle"),!1;Questions.setSearched(d)}}else return this.errMsg="\u8acb\u81f3\u5c11\u9078\u64c7\u4e00\u7a2e\u984c\u578b",$("#warning").modal("toggle"),!1;c=new Date;c.setDate(c.getDate()+7);e.put("quiz.settings",angular.toJson(a),{expires:c});return!0};this.initQuestions=function(){var a=e.get("quiz.settings"),a=void 0===a?Util.getDefaultSettings():$.extend(Util.getDefaultSettings(),angular.fromJson(a)),b={};"boolean"===typeof a["class"]?b["class"]={"!is":"undefined"}:"string"===typeof a["class"]&&(b["class"]=a["class"].split(","));a.single&&!a.multi?b.type="single":a.multi&&!a.single&&(b.type="multi");b=Questions.get(b);0===b.length?(Questions.set(Questions.get({"class":{"!is":"undefined"}})),$.extend(a,{"class":!0,single:!0,multi:!0}),b=new Date,b.setDate(b.getDate()+7),e.put("quiz.settings",angular.toJson(a),{expires:b})):Questions.set(b);this.random=a.random;this.browse=a.browse;this.title=a.title;this.questions={length:Questions.get().length};a.random?(Util.shuffle(Questions.get()),this.index=0):(Questions.get().sort(function(a,b){return a.__id-b.__id}),this.index=a.memorize&&a.position<this.questions.length?a.position:0);this.next(0)};this.toError=function(){this.tab="error";$(".navbar-toggle").click();this.eIndex=this.eMax=Questions.getErrors().length-1;this.nextError(0)};this.nextError=function(a){a=this.eIndex+a;a===Questions.getErrors().length&&(a=0);this.eIndex=a;this.question=Questions.getErrors()[this.eIndex]};this.closeError=function(){this.tab="quiz";this.next(0)};this.clearError=function(){Questions.clearErrors();this.closeError();this.hasErrors=!1;$(".navbar-toggle").click()};this.search=function(){$("#errmsg2").hide();$("#keyword").val(this.keyword.join(";"));this.keywordRuleAnd?$("#and").prop("checked",!0):$("#or").prop("checked",!0);$("#search").modal("toggle");$(".navbar-toggle").click()};this.searchFor=function(){var a=$("#keyword").val().toLowerCase().split(";"),b=$.grep(a,function(b,c){return""!==b&&a.indexOf(b)===c});if(0!==b.length){var c=this.keyword,d=this.keywordRuleAnd;this.keyword=b;this.keywordRuleAnd=$("#and").prop("checked");this.initKeyword()?$("#search").modal("toggle"):(this.keyword=c,this.keywordRuleAnd=d,$("#keyword").val(this.keyword.join(";")),this.keywordRuleAnd?$("#and").prop("checked",!0):$("#or").prop("checked",!0))}else 0!==this.keyword.length?(this.keyword=b,this.keywordRuleAnd=$("#and").prop("checked"),this.initQuestions()):this.keywordRuleAnd=$("#and").prop("checked"),$("#search").modal("toggle")};this.initKeyword=function(){var a=e.get("quiz.settings"),a=void 0===a?Util.getDefaultSettings():$.extend(Util.getDefaultSettings(),angular.fromJson(a)),b={};"boolean"===typeof a["class"]?b["class"]={"!is":"undefined"}:"string"===typeof a["class"]&&(b["class"]=a["class"].split(","));a.single&&!a.multi?b.type="single":a.multi&&!a.single&&(b.type="multi");b=Questions.search(b,this.keyword,$("#and").prop("checked"));if(0===b.length)return $("#errmsg2").show(),!1;$("#errmsg2").hide();Questions.setSearched(b);this.random=a.random;this.browse=a.browse;this.title=a.title;this.questions={length:Questions.search().length};a.random?(Util.shuffle(Questions.search()),this.index=0):(Questions.search().sort(function(a,b){return a.__id-b.__id}),this.index=a.memorize&&a.position<this.questions.length?a.position:0);this.next(0);return!0}}]);